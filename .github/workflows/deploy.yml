name: Deploy to AWS

on:
  push:
    branches: [main]
    paths:
      - 'app/**'

env:
  AWS_REGION: eu-west-2
  ECR_REPOSITORY: url-shortener
  IMAGE_TAG: ${{ github.sha }}

permissions:
  id-token: write
  contents: read

jobs:
  build-test-deploy:
    name: Build, Test & Deploy
    runs-on: ubuntu-latest

    steps:
      # ==========================================
      # 1. CHECKOUT & LINT
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: app/Dockerfile

      # ==========================================
      # 2. Inject env vars required by app for CI testing
      # ==========================================
 - name: Inject env vars required by app
  run: |
    echo "TABLE_NAME=url-dynamo-table" >> $GITHUB_ENV
    echo "AWS_REGION=eu-west-2" >> $GITHUB_ENV
    echo "AWS_DEFAULT_REGION=eu-west-2" >> $GITHUB_ENV
    echo "AWS_ACCESS_KEY_ID=test" >> $GITHUB_ENV
    echo "AWS_SECRET_ACCESS_KEY=test" >> $GITHUB_ENV
    echo "PORT=8080" >> $GITHUB_ENV


      # ==========================================
      # 3. BUILD & TEST LOCALLY
      # ==========================================
      - name: Build Docker image
        working-directory: ./app
        run: docker build -t url-shortener:test .

      - name: Test container locally
        run: |
          docker run -d --name test-container \
            -p 8080:8080 \
            -e TABLE_NAME=$TABLE_NAME \
            -e AWS_REGION=$AWS_REGION \
            -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
            -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
            -e PORT=$PORT \
            url-shortener:test

          echo "Waiting 5 seconds for container startup..."
          sleep 5

          echo "=== CONTAINER STATUS ==="
          docker ps -a

          echo "=== CONTAINER LOGS ==="
          docker logs test-container || true
          echo "========================"

          echo "Testing health endpoint..."
          curl -v http://localhost:8080/healthz

      # ==========================================
      # 4. SCAN IMAGE
      # ==========================================
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: url-shortener:test
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      # ==========================================
      # 5. AUTH â†’ AWS
      # ==========================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-deploy
          aws-region: ${{ env.AWS_REGION }}

      # ==========================================
      # 6. PUSH TO ECR
      # ==========================================
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag and push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker tag url-shortener:test $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag url-shortener:test $ECR_REGISTRY/$ECR_REPOSITORY:latest

          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # ==========================================
      # 7. UPDATE ECS TASK DEF
      # ==========================================
      - name: Register new ECS task definition
        id: register-task
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          TASK_FAMILY="url-task-definition-tf"
          NEW_IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

          TASK_DEF=$(aws ecs describe-task-definition --task-definition $TASK_FAMILY)

          NEW_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$NEW_IMAGE" \
            '.taskDefinition |
             .containerDefinitions[0].image = $IMAGE |
             del(.status, .revision, .taskDefinitionArn, .requiresAttributes,
                 .compatibilities, .registeredAt, .registeredBy)')

          echo "$NEW_TASK_DEF" > new-task-def.json

          TASK_DEF_ARN=$(aws ecs.register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "TASK_DEF_ARN=$TASK_DEF_ARN" >> $GITHUB_ENV

      # ==========================================
      # 8. DEPLOY VIA CODEDEPLOY
      # ==========================================
      - name: Deploy via CodeDeploy
        env:
          APPLICATION_NAME: url-codedeploy-app-tf
          DEPLOYMENT_GROUP_NAME: url-codedeploy-dg
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "$APPLICATION_NAME" \
            --deployment-group-name "$DEPLOYMENT_GROUP_NAME" \
            --revision "{\"revisionType\":\"AppSpecContent\",\"appSpecContent\":{\"content\":\"{\\\"version\\\":1,\\\"Resources\\\":[{\\\"TargetService\\\":{\\\"Type\\\":\\\"AWS::ECS::Service\\\",\\\"Properties\\\":{\\\"TaskDefinition\\\":\\\"$TASK_DEF_ARN\\\",\\\"LoadBalancerInfo\\\":{\\\"ContainerName\\\":\\\"url-shortener-app-tf\\\",\\\"ContainerPort\\\":8080}}}}]}\"}}" \
            --region "$AWS_REGION" \
            --query 'deploymentId' \
            --output text)

          aws deploy wait deployment-successful \
            --deployment-id $DEPLOYMENT_ID \
            --region $AWS_REGION

      # ==========================================
      # 9. CONFIRM
      # ==========================================
      - name: Verify deployment
        run: |
          echo "Deployment complete."
          echo "Image: ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "Task Definition: $TASK_DEF_ARN"
