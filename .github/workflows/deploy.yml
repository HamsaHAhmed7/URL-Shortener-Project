name: Deploy to AWS

on:
  push:
    branches: [main]
    paths:
      - 'app/**'

env:
  AWS_REGION: eu-west-2
  ECR_REPOSITORY: url-shortener
  IMAGE_TAG: ${{ github.sha }}

permissions:
  id-token: write
  contents: read

jobs:
  build-test-deploy:
    name: Build, Test & Deploy
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================
      # 1. CHECKOUT & LINT
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: app/Dockerfile

      # ==========================================
      # 2. BUILD & TEST LOCALLY
      # ==========================================
      - name: Build Docker image
        working-directory: ./app
        run: docker build -t url-shortener:test .

      - name: Test container locally
        run: |
          docker run -d --name test-container \
            -p 8080:8080 \
            -e TABLE_NAME=url-dynamo-table \
            -e AWS_REGION=eu-west-2 \
            url-shortener:test
          
          echo "Waiting for container to start..."
          sleep 10
          
          echo "Testing health endpoint..."
          curl -f http://localhost:8080/healthz || exit 1
          
          echo "âœ… Container test passed!"
          
          docker stop test-container
          docker rm test-container

      # ==========================================
      # 3. SCAN IMAGE
      # ==========================================
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: url-shortener:test
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail, just report

      # ==========================================
      # 4. PUSH TO ECR
      # ==========================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag and push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker tag url-shortener:test $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag url-shortener:test $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "âœ… Pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      # ==========================================
      # 5. UPDATE ECS TASK DEFINITION
      # ==========================================
      - name: Register new ECS task definition
        id: register-task
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          TASK_FAMILY="url-task-definition-tf"
          NEW_IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          
          # Get current task definition
          TASK_DEF=$(aws ecs describe-task-definition --task-definition $TASK_FAMILY)
          
          # Update image in task definition
          NEW_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$NEW_IMAGE" \
            '.taskDefinition | 
             .containerDefinitions[0].image = $IMAGE | 
             del(.status, .revision, .taskDefinitionArn, .requiresAttributes, 
                 .compatibilities, .registeredAt, .registeredBy)')
          
          # Save to file
          echo "$NEW_TASK_DEF" > new-task-def.json
          
          # Register new task definition
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "New task definition: $TASK_DEF_ARN"
          echo "TASK_DEF_ARN=$TASK_DEF_ARN" >> $GITHUB_ENV

      # ==========================================
      # 6. DEPLOY VIA CODEDEPLOY (BLUE/GREEN)
      # ==========================================
      - name: Deploy via CodeDeploy
        env:
          APPLICATION_NAME: url-codedeploy-app-tf
          DEPLOYMENT_GROUP_NAME: url-codedeploy-dg
        run: |
          echo "Creating CodeDeploy deployment..."
          
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "$APPLICATION_NAME" \
            --deployment-group-name "$DEPLOYMENT_GROUP_NAME" \
            --revision "{\"revisionType\":\"AppSpecContent\",\"appSpecContent\":{\"content\":\"{\\\"version\\\":1,\\\"Resources\\\":[{\\\"TargetService\\\":{\\\"Type\\\":\\\"AWS::ECS::Service\\\",\\\"Properties\\\":{\\\"TaskDefinition\\\":\\\"$TASK_DEF_ARN\\\",\\\"LoadBalancerInfo\\\":{\\\"ContainerName\\\":\\\"url-shortener-app-tf\\\",\\\"ContainerPort\\\":8080}}}}]}\"}}" \
            --region "$AWS_REGION" \
            --query 'deploymentId' \
            --output text)
          
          echo "Deployment ID: $DEPLOYMENT_ID"
          
          # Wait for deployment to complete
          echo "Waiting for deployment to complete..."
          aws deploy wait deployment-successful \
            --deployment-id $DEPLOYMENT_ID \
            --region $AWS_REGION
          
          echo "âœ… Deployment successful!"

      # ==========================================
      # 7. VERIFY DEPLOYMENT
      # ==========================================
      - name: Verify deployment
        run: |
          echo "=========================================="
          echo "ðŸŽ‰ DEPLOYMENT COMPLETE"
          echo "=========================================="
          echo "Image: ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "Task Definition: $TASK_DEF_ARN"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "=========================================="