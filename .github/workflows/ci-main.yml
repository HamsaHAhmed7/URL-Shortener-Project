name: CI/CD to ECS via CodeDeploy

on:
  push:
    branches:
      - main
    paths:
      - "app/**"
      - "Dockerfile"
      - "requirements.txt"
  workflow_run:
    workflows: ["Terraform CI/CD"]
    types: [completed]
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Only run if triggered by push OR if terraform workflow succeeded
    if: |
      github.event_name == 'push' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: app/Dockerfile
          override-warning: DL3018

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd app
          pip install -r requirements.txt
          pip install bandit safety pytest

      - name: Run Python tests
        run: |
          cd app
          pytest tests/ -v || echo "No tests found"

      - name: Run Bandit (SAST)
        run: bandit -r app/ -ll

      - name: Run Safety (dependency scan)
        run: safety check

      - name: Build Docker image
        run: docker build -t url-shortener:test -f app/Dockerfile app

      - name: Run Trivy (container scan)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'url-shortener:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on CRITICAL/HIGH

      - name: Test image runs
        run: |
          docker run -d --name test-container \
            -p 8080:8080 \
            -e TABLE_NAME=url-dynamo-table \
            -e AWS_DEFAULT_REGION=us-east-1 \
            url-shortener:test
          sleep 10
          curl -f http://localhost:8080/healthz || exit 1
          docker stop test-container
          docker rm test-container

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::016873651140:role/Github_to_AWS_Url
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag and push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: url-shortener-repo
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker tag url-shortener:test $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag url-shortener:test $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "✅ Pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Register new ECS task definition
        id: register-task
        run: |
          TASK_FAMILY="url-task-definition-tf"
          NEW_IMAGE="${{ steps.login-ecr.outputs.registry }}/url-shortener-repo:${{ github.sha }}"
          
          # Get current task definition
          TASK_DEF=$(aws ecs describe-task-definition --task-definition $TASK_FAMILY)
          
          # Create new task definition with updated image
          NEW_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$NEW_IMAGE" \
            '.taskDefinition | 
            .containerDefinitions[0].image = $IMAGE | 
            del(.status, .revision, .taskDefinitionArn, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')
          
          echo "$NEW_TASK_DEF" > new-task-def.json
          
          # Register new task definition
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "TASK_DEF_ARN=$TASK_DEF_ARN" >> $GITHUB_ENV
          echo "✅ Registered task definition: $TASK_DEF_ARN"

      - name: Trigger CodeDeploy Deployment
        env:
          AWS_REGION: us-east-1
          APPLICATION_NAME: url-codedeploy-app-tf
          DEPLOYMENT_GROUP_NAME: url-codedeploy-dg
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "$APPLICATION_NAME" \
            --deployment-group-name "$DEPLOYMENT_GROUP_NAME" \
            --revision "{\"revisionType\":\"AppSpecContent\",\"appSpecContent\":{\"content\":\"{\\\"version\\\":1,\\\"Resources\\\":[{\\\"TargetService\\\":{\\\"Type\\\":\\\"AWS::ECS::Service\\\",\\\"Properties\\\":{\\\"TaskDefinition\\\":\\\"$TASK_DEF_ARN\\\",\\\"LoadBalancerInfo\\\":{\\\"ContainerName\\\":\\\"url-shortener-app-tf\\\",\\\"ContainerPort\\\":8080}}}}]}\"}}" \
            --region "$AWS_REGION" \
            --query 'deploymentId' \
            --output text)
          
          echo "✅ Started CodeDeploy deployment: $DEPLOYMENT_ID"
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV

      - name: Wait for deployment
        env:
          AWS_REGION: us-east-1
        run: |
          echo "⏳ Waiting for deployment to complete..."
          aws deploy wait deployment-successful \
            --deployment-id $DEPLOYMENT_ID \
            --region $AWS_REGION
          echo "✅ Deployment completed successfully!"