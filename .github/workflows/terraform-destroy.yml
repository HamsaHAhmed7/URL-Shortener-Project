name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "destroy-all-resources" to confirm'
        required: true
        type: string
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  destroy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    defaults:
      run:
        working-directory: terraform/environments/${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "destroy-all-resources" ]; then
            echo "‚ùå Confirmation text doesn't match. Expected 'destroy-all-resources'"
            exit 1
          fi
          echo "‚úÖ Confirmation verified"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::016873651140:role/Github_to_AWS_Url
          aws-region: us-east-1

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan Destroy
        run: terraform plan -destroy -no-color

      - name: Wait before destroy
        run: |
          echo "‚è≥ Waiting 30 seconds before destruction..."
          echo "‚ö†Ô∏è  This is your last chance to cancel!"
          sleep 30

      - name: Terraform Destroy
        run: |
          terraform destroy -auto-approve -input=false
          echo "üî• Infrastructure destroyed for ${{ github.event.inputs.environment }}"

      - name: Create destruction record
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üî• Infrastructure Destroyed - ${{ github.event.inputs.environment }}`;
            const body = `**Environment:** ${{ github.event.inputs.environment }}
            **Destroyed by:** @${{ github.actor }}
            **Timestamp:** ${new Date().toISOString()}
            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            **Status:** ${{ job.status }}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['infrastructure', 'destruction']
            });
